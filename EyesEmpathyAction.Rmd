---
title: "Eyes, Empathy and Action"
author: "Katharina Hellmund & Nadia Hajighassem"
date: "2023-12-09"
output: html_document
---

# Setup and Preparation

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, include = TRUE, message = FALSE, warning = FALSE)

#Calling functions
source("Functions.R")

#Calling packages
pacman::p_load(
  "XML",
  "tidyverse",
  "fs",
  "assertthat",
  "stringi",
  "dtw",
  "RTransferEntropy",
  "signal",
  "conflicted",
  "Rcpp",
  "future",
  "ggplot2",
  "hrbrthemes"
)

#Aesthetic setup
theme_set(theme_ipsum(base_family = "Times New Roman"))
global_fill_colour <- "#8d5b5a"
aesthetic_palette <- c(
  "#d8aeb5","#c17f8c","#b59592","#9b6f69","#a94f62","#8d5b5a","#684141","#733545","#523438","#48222b","#2f1a1b")
aesthetic_highlight_difference_palette <- c("#d8aeb5","#2f1a1b")
```

# Pre-processing

## Empathy-Questionnaire

### Loading in Data and Cleaning

```{r load_personality_data}
#No 9 or 11 :) the data jumps.
#Unknown data could be: A1, A6
personality_questionnaire <- read_csv('data/PercAct23_Mocap_personality_questionnaires.csv')%>% 
  dplyr::filter(`I was a participant in the Mocap workshop`=="Yep") %>%
  mutate(`Participant ID` = case_when(
    `Participant ID` == "7A" ~ "A7",
    `Participant ID` == "b12" ~ "B12",
    `Participant ID` == "6b" ~ "B6",
    `Participant ID` == "12 A" ~ "A12",
    `Participant ID` == "B01" ~ "B1",
    `Participant ID` == "A" ~ "A6",
    `Participant ID` == "nnn" ~ "A1",
    `Participant ID` == "H7" ~ "A13",
    TRUE ~ `Participant ID`  # If no match, keep the original value
  )) 

empathy_questionnaire <- personality_questionnaire %>% 
  select(
    "Participant ID",
    "Gender",
    "Age",
    starts_with("Question")
  ) %>%
  rename_with(~paste0("question:", str_replace_all(.x, "Question|\\[|\\]", "")), starts_with("Question"))

empathy_questionnaire <- empathy_questionnaire %>%
  mutate(across(starts_with("question:"), ~as.numeric(str_replace_all(., "[^0-9]", ""))))
```

## Dance experience Survey

In order to account for experience with dance we score each participant according to their answers on the survey

```{r dance_data}

```

## Motion Capture

```{r motion_data}
synchrony_scores <- read_csv("data/dtw_results.csv")
```

# Exploratory data-analysis

```{r}
#Gender plot
personality_questionnaire %>% 
  ggplot(aes(x=Gender))+
  geom_bar(fill= global_fill_colour)+
  labs(title = "Distribution of Gender",
       x = "Gender",
       y = "Count")
  

#Age plot
personality_questionnaire %>% 
  ggplot(aes(x=Age))+
  geom_bar(fill = global_fill_colour)+
  labs(title = "Distribution of Age",
       x = "Age",
       y = "Count")
```

# Empathy scoring

We start out by making a database for each question, its weight and whether it is reversed or not (counts negatively towards the final score.

```{r}
empathy_question_weights <- data.frame(
  original_index = c("1",
            "3",
            "4",
            "8",
            "9",
            "11",
            "12",
            "13",
            "14",
            "15",
            "18",
            "21",
            "22",
            "26",
            "28",
            "29",
            "31",
            "34",
            "35",
            "36",
            "38",
            "39"),
  question = c("I can easily tell if someone else wants to enter a conversation.", 
               "I really enjoy caring for other people.",
               "I ﬁnd it hard to know what to do in a social situation.",
               "I often ﬁnd it diﬃcult to judge if something is rude or polite.",
               "In a conversation, I tend to focus on my own thoughts rather than on what my listener might be

thinking.",
               "I can pick up quickly if someone says one thing but means another.",
               "It is hard for me to see why some things upset people so much.",
               "I ﬁnd it easy to put myself in somebody else's shoes.",
               "I am good at predicting how someone will feel.",
               "I am quick to spot when someone in a group is feeling awkward or uncomfortable.",
               "I can't always see why someone should have felt oﬀended by a remark.",
               "I don't tend to ﬁnd social situations confusing.",
               "Other people tell me I am good at understanding how they are feeling and what they are

thinking.",
               "I can easily tell if someone else is interested or bored with what I am saying.",
               "Friends usually talk to me about their problems as they say that I am very understanding.",
               "I can sense if I am intruding, even if the other person doesn't tell me.",
               "Other people often say that I am insensitive, though I don't always see why.",
               "I can tune into how someone else feels rapidly and intuitively.",
               "I can easily work out what another person might want to talk about.",
               "I can tell if someone is masking their true emotion.",
               "I am good at predicting what someone will do.",
               "I tend to get emotionally involved with a friend's problems."),
  weight = c("",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             "",
             ""),
  reverse = c("no", 
              "no",
              "yes",
              "yes",
              "yes",
              "no",
              "yes",
              "no",
              "no",
              "no",
              "yes",
              "no",
              "no",
              "no",
              "no",
              "no",
              "yes",
              "no",
              "no",
              "no",
              "no",
              "no")
)
```

Now we make a function for giving each participant an EQ score

```{r}
# Select columns that start with "question:"
question_cols <- empathy_questionnaire %>%
                 select(starts_with("question:"))

# Assuming empathy_question_weights has the same column names as question_cols and a 'reverse' column
columns_to_reverse <- empathy_question_weights$reverse == "yes"
columns_to_reverse <- names(question_cols)[columns_to_reverse]

# Copy the original dataframe
empathy_questionnaire_reversed <- empathy_questionnaire

# Apply the reversal only to the specified columns
empathy_questionnaire_reversed[columns_to_reverse] <- 11 - empathy_questionnaire_reversed[columns_to_reverse]

# Calculate the sum of the "question:" columns per row and add it as a new column
empathy_questionnaire_reversed <- empathy_questionnaire_reversed %>%
                                  rowwise() %>%
                                  mutate(EQ_score = sum(c_across(starts_with("question:")), na.rm = TRUE)) %>%
                                  ungroup()

empathy_questionnaire$EQ_score <- empathy_questionnaire_reversed$EQ_score

write_csv(empathy_questionnaire, "data/EmpathyQuestionnaireScored.csv")

#Removing things from environment to decrease clutter :)
rm(empathy_questionnaire_reversed, empathy_question_weights, question_cols, columns_to_reverse)
```

Plotting the scores

```{r}
empathy_questionnaire %>%
  ggplot(aes(x=EQ_score)) +
  geom_density(fill = global_fill_colour, alpha=0.7) +  # Adds color to the density plot
  xlim(75,175)+
  labs(title="Density Plot of EQ Scores", 
       x="EQ Score", 
       y="Density") +  # Add labels and title
  theme(text = element_text(size=12))  # Adjusts the text size for readability


```

# Empathy and Synchrony

Before plotting we must unify the two dataframes into something usable. There is only one synchrony score per pair, so the A and B pair will have the same score. However, they will each have two scores stemming from the two conditions: Joint Lead and lead follower.

We start by reshaping into a wide format.

```{r}
library(tidyr)

# Reshaping the dataframe
synchrony_scores <- synchrony_scores %>%
  pivot_wider(
    names_from = Condition, 
    values_from = DTW_Distance,
    names_prefix = "DTW_"
  )
```

Then we select the columns from the empathy dataframe that we are interested in and add the synchrony scores.

```{r}
# Selecting relevant columns from empathy_questionnaire
empathy_dtw_df <- empathy_questionnaire %>%
  select(`Participant ID`, Gender, Age, EQ_score) %>%
  # Extract the numeric part of the Participant ID
  mutate(Group = as.numeric(str_extract(`Participant ID`, "\\d+")))

# Merge with synchrony_scores
empathy_dtw_df <- empathy_dtw_df %>%
  left_join(synchrony_scores, by = "Group")

#Reshape back into long-format

empathy_dtw_df <- empathy_dtw_df %>%
  pivot_longer(
    cols = starts_with("DTW_"),
    names_to = "DTW_Type",
    values_to = "DTW_Value"
  )


# View the combined dataframe
print(empathy_dtw_df)

```

Now we can plot them to see if there is any relationship:

```{r}
# Create the plot
ggplot(long_format_df, aes(x = EQ_score, y = DTW_Value, color = DTW_Type)) +
  geom_point() +
  labs(
    title = "DTW Values vs EQ Score",
    x = "EQ Score",
    y = "DTW Value",
    color = "Condition"
  )+
  scale_color_manual(values = aesthetic_highlight_difference_palette)

```

## Adding dance experience scores

```{r}

```

# Modelling

We wish to model to account for each participants degree of dance-expertise.
